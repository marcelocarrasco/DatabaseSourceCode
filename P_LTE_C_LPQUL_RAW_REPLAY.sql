--------------------------------------------------------
--  DDL for Procedure P_LTE_C_LPQUL_RAW_REPLAY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "HARRIAGUE"."P_LTE_C_LPQUL_RAW_REPLAY" (P_FECHA_DESDE IN CHAR, P_FECHA_HASTA IN CHAR)
IS
  sql_stmt VARCHAR2(32767);

  TYPE cur_typ IS REF CURSOR;
  cur CUR_TYP;
  limit_in PLS_INTEGER := 100;

 v_bulk_errors EXCEPTION;
PRAGMA EXCEPTION_INIT (v_bulk_errors, -24381);

  -- LOG --
  l_errors VARCHAR2 (4000);
  l_errno    VARCHAR2(4000);
  l_msg    varchar2(4000);
  l_idx    VARCHAR2(4000);
  -- END LOG --

  TYPE t_array_tab IS TABLE OF NOKLTE_PS_LPQUL_MNC1_RAW%ROWTYPE;
  t_array_col t_array_tab;


 BEGIN

     sql_stmt := ' SELECT DISTINCT
      r.MRBTS_ID,
      r.LNBTS_ID,
      r.LNCEL_ID,
      r.MCC_ID,
      r.MNC_ID,
      r.PERIOD_START_TIME + 7 PERIOD_START_TIME,
      r.PERIOD_DURATION,
      r.PERIOD_DURATION_SUM,
      r.RSSI_PUCCH_MIN,
      r.RSSI_PUCCH_MAX,
      r.RSSI_PUCCH_AVG,
      r.RSSI_PUSCH_MIN,
      r.RSSI_PUSCH_MAX,
      r.RSSI_PUSCH_AVG,
      r.RSSI_PUCCH_LEVEL_01,
      r.RSSI_PUCCH_LEVEL_02,
      r.RSSI_PUCCH_LEVEL_03,
      r.RSSI_PUCCH_LEVEL_04,
      r.RSSI_PUCCH_LEVEL_05,
      r.RSSI_PUCCH_LEVEL_06,
      r.RSSI_PUCCH_LEVEL_07,
      r.RSSI_PUCCH_LEVEL_08,
      r.RSSI_PUCCH_LEVEL_09,
      r.RSSI_PUCCH_LEVEL_10,
      r.RSSI_PUCCH_LEVEL_11,
      r.RSSI_PUCCH_LEVEL_12,
      r.RSSI_PUCCH_LEVEL_13,
      r.RSSI_PUCCH_LEVEL_14,
      r.RSSI_PUCCH_LEVEL_15,
      r.RSSI_PUCCH_LEVEL_16,
      r.RSSI_PUCCH_LEVEL_17,
      r.RSSI_PUCCH_LEVEL_18,
      r.RSSI_PUCCH_LEVEL_19,
      r.RSSI_PUCCH_LEVEL_20,
      r.RSSI_PUCCH_LEVEL_21,
      r.RSSI_PUCCH_LEVEL_22,
      r.RSSI_PUSCH_LEVEL_01,
      r.RSSI_PUSCH_LEVEL_02,
      r.RSSI_PUSCH_LEVEL_03,
      r.RSSI_PUSCH_LEVEL_04,
      r.RSSI_PUSCH_LEVEL_05,
      r.RSSI_PUSCH_LEVEL_06,
      r.RSSI_PUSCH_LEVEL_07,
      r.RSSI_PUSCH_LEVEL_08,
      r.RSSI_PUSCH_LEVEL_09,
      r.RSSI_PUSCH_LEVEL_10,
      r.RSSI_PUSCH_LEVEL_11,
      r.RSSI_PUSCH_LEVEL_12,
      r.RSSI_PUSCH_LEVEL_13,
      r.RSSI_PUSCH_LEVEL_14,
      r.RSSI_PUSCH_LEVEL_15,
      r.RSSI_PUSCH_LEVEL_16,
      r.RSSI_PUSCH_LEVEL_17,
      r.RSSI_PUSCH_LEVEL_18,
      r.RSSI_PUSCH_LEVEL_19,
      r.RSSI_PUSCH_LEVEL_20,
      r.RSSI_PUSCH_LEVEL_21,
      r.RSSI_PUSCH_LEVEL_22,
      r.UL_BLER_QPSK_ALL_TRANS_AVG,
      r.UL_BLER_16QAM_ALL_TRANS_AVG,
      r.UL_BLER_QPSK_FIRST_TRANS_AVG,
      r.UL_BLER_16QAM_FIRST_TRANS_AVG,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL1,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL2,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL3,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL4,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL5,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL6,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL7,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL8,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL9,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL10,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL11,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL12,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL13,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL14,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL15,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL16,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL17,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL18,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL19,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL20,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL21,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL22,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL23,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL24,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL25,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL26,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL27,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL28,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL29,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL30,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL31,
      r.UE_PWR_HEADROOM_PUSCH_LEVEL32,
      r.UE_PWR_HEADROOM_PUSCH_MIN,
      r.UE_PWR_HEADROOM_PUSCH_MAX,
      r.UE_PWR_HEADROOM_PUSCH_AVG,
      r.SINR_PUCCH_MIN,
      r.SINR_PUCCH_MAX,
      r.SINR_PUCCH_AVG,
      r.SINR_PUSCH_MIN,
      r.SINR_PUSCH_MAX,
      r.SINR_PUSCH_AVG,
      r.SINR_PUCCH_LEVEL_1,
      r.SINR_PUCCH_LEVEL_2,
      r.SINR_PUCCH_LEVEL_3,
      r.SINR_PUCCH_LEVEL_4,
      r.SINR_PUCCH_LEVEL_5,
      r.SINR_PUCCH_LEVEL_6,
      r.SINR_PUCCH_LEVEL_7,
      r.SINR_PUCCH_LEVEL_8,
      r.SINR_PUCCH_LEVEL_9,
      r.SINR_PUCCH_LEVEL_10,
      r.SINR_PUCCH_LEVEL_11,
      r.SINR_PUCCH_LEVEL_12,
      r.SINR_PUCCH_LEVEL_13,
      r.SINR_PUCCH_LEVEL_14,
      r.SINR_PUCCH_LEVEL_15,
      r.SINR_PUCCH_LEVEL_16,
      r.SINR_PUCCH_LEVEL_17,
      r.SINR_PUCCH_LEVEL_18,
      r.SINR_PUCCH_LEVEL_19,
      r.SINR_PUCCH_LEVEL_20,
      r.SINR_PUCCH_LEVEL_21,
      r.SINR_PUCCH_LEVEL_22,
      r.SINR_PUSCH_LEVEL_1,
      r.SINR_PUSCH_LEVEL_2,
      r.SINR_PUSCH_LEVEL_3,
      r.SINR_PUSCH_LEVEL_4,
      r.SINR_PUSCH_LEVEL_5,
      r.SINR_PUSCH_LEVEL_6,
      r.SINR_PUSCH_LEVEL_7,
      r.SINR_PUSCH_LEVEL_8,
      r.SINR_PUSCH_LEVEL_9,
      r.SINR_PUSCH_LEVEL_10,
      r.SINR_PUSCH_LEVEL_11,
      r.SINR_PUSCH_LEVEL_12,
      r.SINR_PUSCH_LEVEL_13,
      r.SINR_PUSCH_LEVEL_14,
      r.SINR_PUSCH_LEVEL_15,
      r.SINR_PUSCH_LEVEL_16,
      r.SINR_PUSCH_LEVEL_17,
      r.SINR_PUSCH_LEVEL_18,
      r.SINR_PUSCH_LEVEL_19,
      r.SINR_PUSCH_LEVEL_20,
      r.SINR_PUSCH_LEVEL_21,
      r.SINR_PUSCH_LEVEL_22,
      r.UL_AMC_UPGRADE,
      r.UL_AMC_DOWNGRADE,
      r.UE_DELTA_TX_PUSCH_LEVEL1,
      r.UE_DELTA_TX_PUSCH_LEVEL2,
      r.UE_DELTA_TX_PUSCH_LEVEL3,
      r.UE_DELTA_TX_PUSCH_LEVEL4,
      r.UE_DELTA_TX_PUSCH_LEVEL5,
      r.UE_DELTA_TX_PUSCH_LEVEL6,
      r.UE_DELTA_TX_PUSCH_LEVEL7,
      r.UE_DELTA_TX_PUSCH_LEVEL8,
      r.UE_DELTA_TX_PUSCH_LEVEL9,
      r.UE_DELTA_TX_PUSCH_LEVEL10,
      r.UE_DELTA_TX_PUSCH_LEVEL11,
      r.UE_DELTA_TX_PUSCH_LEVEL12,
      r.UE_DELTA_TX_PUSCH_LEVEL13,
      r.UE_DELTA_TX_PUSCH_LEVEL14,
      r.UE_DELTA_TX_PUSCH_LEVEL15,
      r.UE_DELTA_TX_PUSCH_LEVEL16,
      r.UE_DELTA_TX_PUSCH_LEVEL17,
      r.UE_DELTA_TX_PUSCH_LEVEL18,
      r.UE_DELTA_TX_PUSCH_LEVEL19,
      r.UE_DELTA_TX_PUSCH_LEVEL20,
      r.UE_DELTA_TX_PUSCH_LEVEL21,
      r.UE_DELTA_TX_PUSCH_LEVEL22,
      r.UE_DELTA_TX_PUSCH_LEVEL23,
      r.UE_DELTA_TX_PUSCH_LEVEL24,
      r.UE_DELTA_TX_PUSCH_LEVEL25,
      r.UE_DELTA_TX_PUSCH_LEVEL26,
      r.UE_DELTA_TX_PUSCH_LEVEL27,
      r.UE_DELTA_TX_PUSCH_LEVEL28,
      r.UE_DELTA_TX_PUSCH_LEVEL29,
      r.UE_DELTA_TX_PUSCH_LEVEL30,
      r.UE_DELTA_TX_PUSCH_LEVEL31,
      r.UE_DELTA_TX_PUSCH_LEVEL32,
      r.UE_DELTA_TX_PUCCH_LEVEL1,
      r.UE_DELTA_TX_PUCCH_LEVEL2,
      r.UE_DELTA_TX_PUCCH_LEVEL3,
      r.UE_DELTA_TX_PUCCH_LEVEL4,
      r.UE_DELTA_TX_PUCCH_LEVEL5,
      r.UE_DELTA_TX_PUCCH_LEVEL6,
      r.UE_DELTA_TX_PUCCH_LEVEL7,
      r.UE_DELTA_TX_PUCCH_LEVEL8,
      r.UE_DELTA_TX_PUCCH_LEVEL9,
      r.UE_DELTA_TX_PUCCH_LEVEL10,
      r.UE_DELTA_TX_PUCCH_LEVEL11,
      r.UE_DELTA_TX_PUCCH_LEVEL12,
      r.UE_DELTA_TX_PUCCH_LEVEL13,
      r.UE_DELTA_TX_PUCCH_LEVEL14,
      r.UE_DELTA_TX_PUCCH_LEVEL15,
      r.UE_DELTA_TX_PUCCH_LEVEL16,
      r.UE_DELTA_TX_PUCCH_LEVEL17,
      r.UE_DELTA_TX_PUCCH_LEVEL18,
      r.UE_DELTA_TX_PUCCH_LEVEL19,
      r.UE_DELTA_TX_PUCCH_LEVEL20,
      r.UE_DELTA_TX_PUCCH_LEVEL21,
      r.UE_DELTA_TX_PUCCH_LEVEL22,
      r.UE_DELTA_TX_PUCCH_LEVEL23,
      r.UE_DELTA_TX_PUCCH_LEVEL24,
      r.UE_DELTA_TX_PUCCH_LEVEL25,
      r.UE_DELTA_TX_PUCCH_LEVEL26,
      r.UE_DELTA_TX_PUCCH_LEVEL27,
      r.UE_DELTA_TX_PUCCH_LEVEL28,
      r.UE_DELTA_TX_PUCCH_LEVEL29,
      r.UE_DELTA_TX_PUCCH_LEVEL30,
      r.UE_DELTA_TX_PUCCH_LEVEL31,
      r.UE_DELTA_TX_PUCCH_LEVEL32,
      r.RSSI_CELL_PUCCH_MIN,
      r.RSSI_CELL_PUCCH_MAX,
      r.RSSI_CELL_PUCCH_MEAN,
      r.RSSI_CELL_PUCCH_LEVEL_1,
      r.RSSI_CELL_PUCCH_LEVEL_2,
      r.RSSI_CELL_PUCCH_LEVEL_3,
      r.RSSI_CELL_PUCCH_LEVEL_4,
      r.RSSI_CELL_PUCCH_LEVEL_5,
      r.RSSI_CELL_PUCCH_LEVEL_6,
      r.RSSI_CELL_PUCCH_LEVEL_7,
      r.RSSI_CELL_PUCCH_LEVEL_8,
      r.RSSI_CELL_PUCCH_LEVEL_9,
      r.RSSI_CELL_PUCCH_LEVEL_10,
      r.RSSI_CELL_PUCCH_LEVEL_11,
      r.RSSI_CELL_PUCCH_LEVEL_12,
      r.RSSI_CELL_PUCCH_LEVEL_13,
      r.RSSI_CELL_PUCCH_LEVEL_14,
      r.RSSI_CELL_PUCCH_LEVEL_15,
      r.RSSI_CELL_PUCCH_LEVEL_16,
      r.RSSI_CELL_PUCCH_LEVEL_17,
      r.RSSI_CELL_PUCCH_LEVEL_18,
      r.RSSI_CELL_PUCCH_LEVEL_19,
      r.RSSI_CELL_PUCCH_LEVEL_20,
      r.RSSI_CELL_PUCCH_LEVEL_21,
      r.RSSI_CELL_PUCCH_LEVEL_22,
      r.RSSI_CELL_PUSCH_MIN,
      r.RSSI_CELL_PUSCH_MAX,
      r.RSSI_CELL_PUSCH_MEAN,
      r.RSSI_CELL_PUSCH_LEVEL_1,
      r.RSSI_CELL_PUSCH_LEVEL_2,
      r.RSSI_CELL_PUSCH_LEVEL_3,
      r.RSSI_CELL_PUSCH_LEVEL_4,
      r.RSSI_CELL_PUSCH_LEVEL_5,
      r.RSSI_CELL_PUSCH_LEVEL_6,
      r.RSSI_CELL_PUSCH_LEVEL_7,
      r.RSSI_CELL_PUSCH_LEVEL_8,
      r.RSSI_CELL_PUSCH_LEVEL_9,
      r.RSSI_CELL_PUSCH_LEVEL_10,
      r.RSSI_CELL_PUSCH_LEVEL_11,
      r.RSSI_CELL_PUSCH_LEVEL_12,
      r.RSSI_CELL_PUSCH_LEVEL_13,
      r.RSSI_CELL_PUSCH_LEVEL_14,
      r.RSSI_CELL_PUSCH_LEVEL_15,
      r.RSSI_CELL_PUSCH_LEVEL_16,
      r.RSSI_CELL_PUSCH_LEVEL_17,
      r.RSSI_CELL_PUSCH_LEVEL_18,
      r.RSSI_CELL_PUSCH_LEVEL_19,
      r.RSSI_CELL_PUSCH_LEVEL_20,
      r.RSSI_CELL_PUSCH_LEVEL_21,
      r.RSSI_CELL_PUSCH_LEVEL_22,
      r.SINR_CELL_PUCCH_MIN,
      r.SINR_CELL_PUCCH_MAX,
      r.SINR_CELL_PUCCH_MEAN,
      r.SINR_CELL_PUCCH_LEVEL_1,
      r.SINR_CELL_PUCCH_LEVEL_2,
      r.SINR_CELL_PUCCH_LEVEL_3,
      r.SINR_CELL_PUCCH_LEVEL_4,
      r.SINR_CELL_PUCCH_LEVEL_5,
      r.SINR_CELL_PUCCH_LEVEL_6,
      r.SINR_CELL_PUCCH_LEVEL_7,
      r.SINR_CELL_PUCCH_LEVEL_8,
      r.SINR_CELL_PUCCH_LEVEL_9,
      r.SINR_CELL_PUCCH_LEVEL_10,
      r.SINR_CELL_PUCCH_LEVEL_11,
      r.SINR_CELL_PUCCH_LEVEL_12,
      r.SINR_CELL_PUCCH_LEVEL_13,
      r.SINR_CELL_PUCCH_LEVEL_14,
      r.SINR_CELL_PUCCH_LEVEL_15,
      r.SINR_CELL_PUCCH_LEVEL_16,
      r.SINR_CELL_PUCCH_LEVEL_17,
      r.SINR_CELL_PUCCH_LEVEL_18,
      r.SINR_CELL_PUCCH_LEVEL_19,
      r.SINR_CELL_PUCCH_LEVEL_20,
      r.SINR_CELL_PUCCH_LEVEL_21,
      r.SINR_CELL_PUCCH_LEVEL_22,
      r.SINR_CELL_PUSCH_MIN,
      r.SINR_CELL_PUSCH_MAX,
      r.SINR_CELL_PUSCH_MEAN,
      r.SINR_CELL_PUSCH_LEVEL_1,
      r.SINR_CELL_PUSCH_LEVEL_2,
      r.SINR_CELL_PUSCH_LEVEL_3,
      r.SINR_CELL_PUSCH_LEVEL_4,
      r.SINR_CELL_PUSCH_LEVEL_5,
      r.SINR_CELL_PUSCH_LEVEL_6,
      r.SINR_CELL_PUSCH_LEVEL_7,
      r.SINR_CELL_PUSCH_LEVEL_8,
      r.SINR_CELL_PUSCH_LEVEL_9,
      r.SINR_CELL_PUSCH_LEVEL_10,
      r.SINR_CELL_PUSCH_LEVEL_11,
      r.SINR_CELL_PUSCH_LEVEL_12,
      r.SINR_CELL_PUSCH_LEVEL_13,
      r.SINR_CELL_PUSCH_LEVEL_14,
      r.SINR_CELL_PUSCH_LEVEL_15,
      r.SINR_CELL_PUSCH_LEVEL_16,
      r.SINR_CELL_PUSCH_LEVEL_17,
      r.SINR_CELL_PUSCH_LEVEL_18,
      r.SINR_CELL_PUSCH_LEVEL_19,
      r.SINR_CELL_PUSCH_LEVEL_20,
      r.SINR_CELL_PUSCH_LEVEL_21,
      r.SINR_CELL_PUSCH_LEVEL_22
FROM NOKLTE_PS_LPQUL_MNC1_RAW r
 INNER JOIN OBJECTS_SP_LTE o
    ON r.LNBTS_ID = o.LNBTS_ID
   AND r.LNCEL_ID = o.LNCEL_ID
 WHERE r.PERIOD_START_TIME BETWEEN TO_DATE(''' || P_FECHA_DESDE ||''', ''DD.MM.YYYY HH24'')
                             AND TO_DATE('''||P_FECHA_HASTA ||''', ''DD.MM.YYYY HH24'')';

  OPEN cur FOR sql_stmt;
  LOOP
    FETCH cur BULK COLLECT INTO t_array_col LIMIT limit_in;
    BEGIN
      FORALL i IN 1 .. t_array_col.COUNT SAVE EXCEPTIONS
        INSERT INTO NOKLTE_PS_LPQUL_MNC1_RAW VALUES t_array_col (i);
        
        
      EXCEPTION WHEN v_bulk_errors THEN
    FOR i in 1..SQL%BULK_EXCEPTIONS.COUNT LOOP
    l_errno := sql%bulk_exceptions(i).error_code;
    l_msg   := sqlerrm(-l_errno);
    l_idx   := sql%bulk_exceptions(i).error_index;

    Dbms_output.put_line(
   'Error cod:' || l_errno ||
   'Mensaje: ' || l_msg );
    END LOOP;
        
    END;
    EXIT WHEN cur%NOTFOUND;
  END LOOP;
  COMMIT;
  CLOSE cur;

 exception
 when others then
 dbms_output.put_line (sqlerrm); 
    

END;

/
